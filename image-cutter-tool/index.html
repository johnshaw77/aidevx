<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>圖片切割器 | Image Cutter Tool</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: white;
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1.1rem;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 20px;
            min-height: 600px;
        }

        /* 圖片上傳和編輯區 */
        .image-editor {
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .editor-header {
            background: linear-gradient(90deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .upload-zone {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 40px;
            border: 3px dashed #ddd;
            margin: 20px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            background: #fafafa;
        }

        .upload-zone:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .upload-zone.dragover {
            border-color: #667eea;
            background: #e3f2fd;
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 4rem;
            color: #ddd;
            margin-bottom: 20px;
            transition: color 0.3s;
        }

        .upload-zone:hover .upload-icon {
            color: #667eea;
        }

        .upload-text {
            font-size: 1.2rem;
            color: #666;
            margin-bottom: 10px;
        }

        .upload-hint {
            font-size: 0.9rem;
            color: #999;
        }

        .image-preview {
            position: relative;
            max-width: 100%;
            max-height: 400px;
            margin: 20px auto;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            display: none;
        }

        .preview-image {
            max-width: 100%;
            max-height: 400px;
            object-fit: contain;
        }

        .crop-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: auto;
            cursor: crosshair;
        }

        .crop-selection {
            position: absolute;
            border: 2px solid #667eea;
            background: rgba(102, 126, 234, 0.1);
            box-shadow: 0 0 0 9999px rgba(0,0,0,0.5);
            cursor: move;
            min-width: 20px;
            min-height: 20px;
        }

        .crop-handle {
            position: absolute;
            width: 8px;
            height: 8px;
            background: #667eea;
            border: 1px solid white;
            border-radius: 50%;
            cursor: pointer;
        }

        .crop-handle.nw { top: -4px; left: -4px; cursor: nw-resize; }
        .crop-handle.ne { top: -4px; right: -4px; cursor: ne-resize; }
        .crop-handle.sw { bottom: -4px; left: -4px; cursor: sw-resize; }
        .crop-handle.se { bottom: -4px; right: -4px; cursor: se-resize; }
        .crop-handle.n { top: -4px; left: 50%; transform: translateX(-50%); cursor: n-resize; }
        .crop-handle.s { bottom: -4px; left: 50%; transform: translateX(-50%); cursor: s-resize; }
        .crop-handle.w { left: -4px; top: 50%; transform: translateY(-50%); cursor: w-resize; }
        .crop-handle.e { right: -4px; top: 50%; transform: translateY(-50%); cursor: e-resize; }

        .crop-info {
            position: absolute;
            top: -30px;
            left: 0;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            pointer-events: none;
        }

        .crop-guides {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .crop-guide {
            position: absolute;
            border: 1px dashed rgba(255, 255, 255, 0.5);
        }

        .crop-guide.horizontal {
            width: 100%;
            height: 0;
        }

        .crop-guide.vertical {
            width: 0;
            height: 100%;
        }

        /* 控制面板 */
        .control-panel {
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            padding: 25px;
            height: fit-content;
        }

        .panel-section {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 1.2rem;
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* 尺寸選擇 */
        .size-presets {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .size-btn {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 12px 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
            font-size: 0.9rem;
        }

        .size-btn:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .size-btn.active {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        .size-value {
            font-weight: bold;
            display: block;
        }

        .size-label {
            font-size: 0.8rem;
            opacity: 0.8;
            margin-top: 2px;
        }

        /* 自定義尺寸 */
        .custom-size {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
        }

        .size-input {
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            text-align: center;
            font-size: 1rem;
        }

        .size-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .multiply-sign {
            font-size: 1.2rem;
            font-weight: bold;
            color: #666;
        }

        /* 批量導出 */
        .batch-export {
            display: grid;
            gap: 10px;
        }

        .export-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .export-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .export-size {
            flex: 1;
            font-weight: 500;
        }

        .export-preview {
            width: 32px;
            height: 32px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            color: #999;
        }

        /* 按鈕 */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
            text-decoration: none;
        }

        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f8f9fa;
            color: #666;
            border: 2px solid #e9ecef;
        }

        .btn-secondary:hover {
            background: #e9ecef;
        }

        .btn-secondary.active {
            background: #667eea;
            color: white;
        }

        .crop-mode-toggle {
            display: flex;
            gap: 5px;
        }

        .btn-block {
            width: 100%;
            margin-bottom: 10px;
        }

        /* 預覽網格 */
        .preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .preview-item {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            border: 2px solid #e9ecef;
            transition: all 0.3s;
        }

        .preview-item:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .preview-canvas {
            width: 64px;
            height: 64px;
            margin: 0 auto 10px;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
        }

        .preview-info {
            font-size: 0.9rem;
            color: #666;
            font-weight: 500;
        }

        /* 工具欄 */
        .toolbar {
            background: white;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .quality-slider {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .slider {
            width: 100px;
        }

        /* 響應式設計 */
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 2rem;
            }

            .size-presets {
                grid-template-columns: repeat(3, 1fr);
            }

            .custom-size {
                grid-template-columns: 1fr;
                gap: 5px;
            }

            .multiply-sign {
                display: none;
            }
        }

        /* 隱藏類 */
        .hidden {
            display: none !important;
        }

        /* 載入動畫 */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 返回首頁按鈕 */
        .home-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.9);
            color: #667eea;
            padding: 10px 20px;
            border-radius: 25px;
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 500;
            z-index: 1000;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .home-btn:hover {
            background: white;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }
    </style>
</head>
<body>
    <a href="../" class="home-btn">
        <i class="fas fa-home"></i> 回到首頁
    </a>

    <div class="container">
        <div class="header">
            <h1><i class="fas fa-cut"></i> 圖片切割器</h1>
            <p>專業的圖片裁剪工具，支援多種Icon尺寸批量導出</p>
        </div>

        <div class="toolbar">
            <div class="quality-slider">
                <i class="fas fa-image"></i>
                <label>輸出品質:</label>
                <input type="range" class="slider" id="qualitySlider" min="0.1" max="1" step="0.1" value="0.9">
                <span id="qualityValue">90%</span>
            </div>
            <div class="crop-mode-toggle">
                <button class="btn btn-secondary" id="autoCropBtn">
                    <i class="fas fa-crop-alt"></i> 自動裁剪
                </button>
                <button class="btn btn-secondary" id="manualCropBtn">
                    <i class="fas fa-crop"></i> 手動裁剪
                </button>
            </div>
            <button class="btn btn-secondary" id="resetBtn">
                <i class="fas fa-undo"></i> 重置
            </button>
        </div>

        <div class="main-content">
            <!-- 圖片編輯區 -->
            <div class="image-editor">
                <div class="editor-header">
                    <h3><i class="fas fa-edit"></i> 圖片編輯器</h3>
                    <p>拖拽或點擊上傳圖片進行編輯</p>
                </div>

                <!-- 上傳區域 -->
                <div class="upload-zone" id="uploadZone">
                    <div class="upload-icon">
                        <i class="fas fa-cloud-upload-alt"></i>
                    </div>
                    <div class="upload-text">點擊或拖拽圖片到這裡</div>
                    <div class="upload-hint">支援 JPG、PNG、GIF、WebP 格式</div>
                    <input type="file" id="imageInput" accept="image/*" style="display: none;">
                </div>

                <!-- 圖片預覽 -->
                <div class="image-preview" id="imagePreview">
                    <img id="previewImg" class="preview-image">
                    <div class="crop-overlay" id="cropOverlay">
                        <div class="crop-selection" id="cropSelection">
                            <div class="crop-info" id="cropInfo">100×100</div>
                            <div class="crop-guides">
                                <div class="crop-guide horizontal" style="top: 33.33%"></div>
                                <div class="crop-guide horizontal" style="top: 66.66%"></div>
                                <div class="crop-guide vertical" style="left: 33.33%"></div>
                                <div class="crop-guide vertical" style="left: 66.66%"></div>
                            </div>
                            <div class="crop-handle nw"></div>
                            <div class="crop-handle ne"></div>
                            <div class="crop-handle sw"></div>
                            <div class="crop-handle se"></div>
                            <div class="crop-handle n"></div>
                            <div class="crop-handle s"></div>
                            <div class="crop-handle w"></div>
                            <div class="crop-handle e"></div>
                        </div>
                    </div>
                </div>

                <!-- 預覽網格 -->
                <div class="preview-grid" id="previewGrid"></div>
            </div>

            <!-- 控制面板 -->
            <div class="control-panel">
                <!-- 預設尺寸 -->
                <div class="panel-section">
                    <div class="section-title">
                        <i class="fas fa-th"></i>
                        常用Icon尺寸
                    </div>
                    <div class="size-presets" id="sizePresets">
                        <div class="size-btn" data-size="16">
                            <span class="size-value">16×16</span>
                            <span class="size-label">Favicon</span>
                        </div>
                        <div class="size-btn" data-size="32">
                            <span class="size-value">32×32</span>
                            <span class="size-label">Small Icon</span>
                        </div>
                        <div class="size-btn" data-size="48">
                            <span class="size-value">48×48</span>
                            <span class="size-label">Windows</span>
                        </div>
                        <div class="size-btn" data-size="64">
                            <span class="size-value">64×64</span>
                            <span class="size-label">Desktop</span>
                        </div>
                        <div class="size-btn" data-size="128">
                            <span class="size-value">128×128</span>
                            <span class="size-label">App Icon</span>
                        </div>
                        <div class="size-btn" data-size="256">
                            <span class="size-value">256×256</span>
                            <span class="size-label">High DPI</span>
                        </div>
                        <div class="size-btn" data-size="512">
                            <span class="size-value">512×512</span>
                            <span class="size-label">Retina</span>
                        </div>
                        <div class="size-btn" data-size="1024">
                            <span class="size-value">1024×1024</span>
                            <span class="size-label">App Store</span>
                        </div>
                    </div>
                </div>

                <!-- 自定義尺寸 -->
                <div class="panel-section">
                    <div class="section-title">
                        <i class="fas fa-ruler"></i>
                        自定義尺寸
                    </div>
                    <div class="custom-size">
                        <input type="number" class="size-input" id="customWidth" placeholder="寬度" min="1" max="2048">
                        <span class="multiply-sign">×</span>
                        <input type="number" class="size-input" id="customHeight" placeholder="高度" min="1" max="2048">
                    </div>
                </div>

                <!-- 批量導出 -->
                <div class="panel-section">
                    <div class="section-title">
                        <i class="fas fa-download"></i>
                        批量導出
                    </div>
                    <div class="batch-export" id="batchExport">
                        <!-- 動態生成 -->
                    </div>
                </div>

                <!-- 操作按鈕 -->
                <div class="panel-section">
                    <button class="btn btn-primary btn-block" id="generateBtn" disabled>
                        <i class="fas fa-magic"></i>
                        生成預覽
                    </button>
                    <button class="btn btn-secondary btn-block" id="downloadSingleBtn" disabled>
                        <i class="fas fa-download"></i>
                        下載單個
                    </button>
                    <button class="btn btn-secondary btn-block" id="downloadBatchBtn" disabled>
                        <i class="fas fa-file-archive"></i>
                        批量下載 ZIP
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
    <script>
        class ImageCutter {
            constructor() {
                this.originalImage = null;
                this.selectedSizes = new Set(['32', '64', '128']);
                this.customWidth = null;
                this.customHeight = null;
                this.quality = 0.9;
                this.cropMode = 'auto'; // 'auto' or 'manual'
                this.cropArea = { x: 0, y: 0, width: 100, height: 100 };
                this.isDragging = false;
                this.dragStart = { x: 0, y: 0 };
                this.resizeHandle = null;
                
                this.initializeElements();
                this.bindEvents();
                this.updateBatchExport();
            }

            initializeElements() {
                // 主要元素
                this.uploadZone = document.getElementById('uploadZone');
                this.imageInput = document.getElementById('imageInput');
                this.imagePreview = document.getElementById('imagePreview');
                this.previewImg = document.getElementById('previewImg');
                this.previewGrid = document.getElementById('previewGrid');
                
                // Cropper 元素
                this.cropOverlay = document.getElementById('cropOverlay');
                this.cropSelection = document.getElementById('cropSelection');
                this.cropInfo = document.getElementById('cropInfo');
                this.autoCropBtn = document.getElementById('autoCropBtn');
                this.manualCropBtn = document.getElementById('manualCropBtn');
                
                // 控制元素
                this.sizePresets = document.getElementById('sizePresets');
                this.customWidthInput = document.getElementById('customWidth');
                this.customHeightInput = document.getElementById('customHeight');
                this.qualitySlider = document.getElementById('qualitySlider');
                this.qualityValue = document.getElementById('qualityValue');
                
                // 按鈕
                this.generateBtn = document.getElementById('generateBtn');
                this.downloadSingleBtn = document.getElementById('downloadSingleBtn');
                this.downloadBatchBtn = document.getElementById('downloadBatchBtn');
                this.resetBtn = document.getElementById('resetBtn');
                
                // 批量導出
                this.batchExport = document.getElementById('batchExport');
            }

            bindEvents() {
                // 文件上傳
                this.uploadZone.addEventListener('click', () => this.imageInput.click());
                this.uploadZone.addEventListener('dragover', this.handleDragOver.bind(this));
                this.uploadZone.addEventListener('dragleave', this.handleDragLeave.bind(this));
                this.uploadZone.addEventListener('drop', this.handleDrop.bind(this));
                this.imageInput.addEventListener('change', this.handleFileSelect.bind(this));

                // 裁剪模式切換
                this.autoCropBtn.addEventListener('click', () => this.setCropMode('auto'));
                this.manualCropBtn.addEventListener('click', () => this.setCropMode('manual'));

                // Cropper 事件
                this.cropOverlay.addEventListener('mousedown', this.handleCropStart.bind(this));
                this.cropSelection.addEventListener('mousedown', this.handleCropDragStart.bind(this));
                document.addEventListener('mousemove', this.handleCropMove.bind(this));
                document.addEventListener('mouseup', this.handleCropEnd.bind(this));
                
                // 調整手柄事件
                this.cropSelection.querySelectorAll('.crop-handle').forEach(handle => {
                    handle.addEventListener('mousedown', this.handleResizeStart.bind(this));
                });

                // 尺寸選擇
                this.sizePresets.addEventListener('click', this.handleSizePresetClick.bind(this));
                
                // 自定義尺寸
                this.customWidthInput.addEventListener('input', this.handleCustomSizeChange.bind(this));
                this.customHeightInput.addEventListener('input', this.handleCustomSizeChange.bind(this));
                
                // 品質調整
                this.qualitySlider.addEventListener('input', this.handleQualityChange.bind(this));
                
                // 按鈕事件
                this.generateBtn.addEventListener('click', this.generatePreviews.bind(this));
                this.downloadSingleBtn.addEventListener('click', this.downloadSingle.bind(this));
                this.downloadBatchBtn.addEventListener('click', this.downloadBatch.bind(this));
                this.resetBtn.addEventListener('click', this.reset.bind(this));
            }

            // 拖拽處理
            handleDragOver(e) {
                e.preventDefault();
                this.uploadZone.classList.add('dragover');
            }

            handleDragLeave(e) {
                e.preventDefault();
                this.uploadZone.classList.remove('dragover');
            }

            handleDrop(e) {
                e.preventDefault();
                this.uploadZone.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0 && files[0].type.startsWith('image/')) {
                    this.loadImage(files[0]);
                }
            }

            handleFileSelect(e) {
                const file = e.target.files[0];
                if (file && file.type.startsWith('image/')) {
                    this.loadImage(file);
                }
            }

            // 載入圖片
            loadImage(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        this.originalImage = img;
                        this.previewImg.src = e.target.result;
                        this.previewImg.onload = () => {
                            this.initializeCropArea();
                        };
                        this.uploadZone.style.display = 'none';
                        this.imagePreview.style.display = 'block';
                        this.generateBtn.disabled = false;
                        this.setCropMode('auto'); // 預設自動模式
                        this.generatePreviews(); // 自動生成預覽
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }

            // 設置裁剪模式
            setCropMode(mode) {
                this.cropMode = mode;
                this.autoCropBtn.classList.toggle('active', mode === 'auto');
                this.manualCropBtn.classList.toggle('active', mode === 'manual');
                this.cropSelection.style.display = mode === 'manual' ? 'block' : 'none';
                
                if (mode === 'manual' && this.originalImage) {
                    this.initializeCropArea();
                }
                
                if (this.originalImage) {
                    this.generatePreviews();
                }
            }

            // 初始化裁剪區域
            initializeCropArea() {
                const rect = this.previewImg.getBoundingClientRect();
                const containerRect = this.imagePreview.getBoundingClientRect();
                
                // 計算圖片在容器中的實際位置和尺寸
                const imgWidth = this.previewImg.clientWidth;
                const imgHeight = this.previewImg.clientHeight;
                const imgLeft = (this.imagePreview.clientWidth - imgWidth) / 2;
                const imgTop = (this.imagePreview.clientHeight - imgHeight) / 2;
                
                // 設置初始裁剪區域為圖片中心的正方形
                const minSize = Math.min(imgWidth, imgHeight);
                const cropSize = minSize * 0.8;
                
                this.cropArea = {
                    x: imgLeft + (imgWidth - cropSize) / 2,
                    y: imgTop + (imgHeight - cropSize) / 2,
                    width: cropSize,
                    height: cropSize
                };
                
                this.updateCropSelection();
            }

            // 更新裁剪框顯示
            updateCropSelection() {
                this.cropSelection.style.left = this.cropArea.x + 'px';
                this.cropSelection.style.top = this.cropArea.y + 'px';
                this.cropSelection.style.width = this.cropArea.width + 'px';
                this.cropSelection.style.height = this.cropArea.height + 'px';
                
                // 更新尺寸信息
                const realWidth = Math.round(this.cropArea.width * this.originalImage.width / this.previewImg.clientWidth);
                const realHeight = Math.round(this.cropArea.height * this.originalImage.height / this.previewImg.clientHeight);
                this.cropInfo.textContent = `${realWidth}×${realHeight}`;
            }

            // 開始創建新的裁剪區域
            handleCropStart(e) {
                if (this.cropMode !== 'manual') return;
                if (e.target === this.cropSelection || this.cropSelection.contains(e.target)) return;
                
                e.preventDefault();
                const rect = this.cropOverlay.getBoundingClientRect();
                this.dragStart.x = e.clientX - rect.left;
                this.dragStart.y = e.clientY - rect.top;
                this.isDragging = true;
                this.cropArea.x = this.dragStart.x;
                this.cropArea.y = this.dragStart.y;
                this.cropArea.width = 0;
                this.cropArea.height = 0;
                this.updateCropSelection();
            }

            // 開始拖動裁剪框
            handleCropDragStart(e) {
                if (this.cropMode !== 'manual') return;
                
                e.preventDefault();
                e.stopPropagation();
                
                const rect = this.cropOverlay.getBoundingClientRect();
                this.dragStart.x = e.clientX - rect.left - this.cropArea.x;
                this.dragStart.y = e.clientY - rect.top - this.cropArea.y;
                this.isDragging = true;
            }

            // 開始調整裁剪框尺寸
            handleResizeStart(e) {
                if (this.cropMode !== 'manual') return;
                
                e.preventDefault();
                e.stopPropagation();
                
                this.resizeHandle = e.target.className.split(' ')[1]; // 獲取方向類名
                const rect = this.cropOverlay.getBoundingClientRect();
                this.dragStart.x = e.clientX - rect.left;
                this.dragStart.y = e.clientY - rect.top;
                this.isDragging = true;
            }

            // 處理鼠標移動
            handleCropMove(e) {
                if (!this.isDragging || this.cropMode !== 'manual') return;
                
                e.preventDefault();
                const rect = this.cropOverlay.getBoundingClientRect();
                const currentX = e.clientX - rect.left;
                const currentY = e.clientY - rect.top;
                
                if (this.resizeHandle) {
                    // 調整尺寸
                    this.handleResize(currentX, currentY);
                } else if (this.cropArea.width === 0 && this.cropArea.height === 0) {
                    // 創建新裁剪區域
                    this.cropArea.width = Math.abs(currentX - this.dragStart.x);
                    this.cropArea.height = Math.abs(currentY - this.dragStart.y);
                    if (currentX < this.dragStart.x) this.cropArea.x = currentX;
                    if (currentY < this.dragStart.y) this.cropArea.y = currentY;
                } else {
                    // 拖動裁剪框
                    this.cropArea.x = currentX - this.dragStart.x;
                    this.cropArea.y = currentY - this.dragStart.y;
                }
                
                // 限制邊界
                this.constrainCropArea();
                this.updateCropSelection();
            }

            // 調整尺寸處理
            handleResize(currentX, currentY) {
                const deltaX = currentX - this.dragStart.x;
                const deltaY = currentY - this.dragStart.y;
                const originalArea = { ...this.cropArea };
                
                switch (this.resizeHandle) {
                    case 'se': // 東南
                        this.cropArea.width = Math.max(20, originalArea.width + deltaX);
                        this.cropArea.height = Math.max(20, originalArea.height + deltaY);
                        break;
                    case 'sw': // 西南
                        this.cropArea.width = Math.max(20, originalArea.width - deltaX);
                        this.cropArea.height = Math.max(20, originalArea.height + deltaY);
                        this.cropArea.x = originalArea.x + deltaX;
                        break;
                    case 'ne': // 東北
                        this.cropArea.width = Math.max(20, originalArea.width + deltaX);
                        this.cropArea.height = Math.max(20, originalArea.height - deltaY);
                        this.cropArea.y = originalArea.y + deltaY;
                        break;
                    case 'nw': // 西北
                        this.cropArea.width = Math.max(20, originalArea.width - deltaX);
                        this.cropArea.height = Math.max(20, originalArea.height - deltaY);
                        this.cropArea.x = originalArea.x + deltaX;
                        this.cropArea.y = originalArea.y + deltaY;
                        break;
                    case 'n': // 北
                        this.cropArea.height = Math.max(20, originalArea.height - deltaY);
                        this.cropArea.y = originalArea.y + deltaY;
                        break;
                    case 's': // 南
                        this.cropArea.height = Math.max(20, originalArea.height + deltaY);
                        break;
                    case 'w': // 西
                        this.cropArea.width = Math.max(20, originalArea.width - deltaX);
                        this.cropArea.x = originalArea.x + deltaX;
                        break;
                    case 'e': // 東
                        this.cropArea.width = Math.max(20, originalArea.width + deltaX);
                        break;
                }
                
                this.dragStart.x = currentX;
                this.dragStart.y = currentY;
            }

            // 限制裁剪區域邊界
            constrainCropArea() {
                const imgWidth = this.previewImg.clientWidth;
                const imgHeight = this.previewImg.clientHeight;
                const imgLeft = (this.imagePreview.clientWidth - imgWidth) / 2;
                const imgTop = (this.imagePreview.clientHeight - imgHeight) / 2;
                
                // 限制在圖片範圍內
                this.cropArea.x = Math.max(imgLeft, Math.min(this.cropArea.x, imgLeft + imgWidth - this.cropArea.width));
                this.cropArea.y = Math.max(imgTop, Math.min(this.cropArea.y, imgTop + imgHeight - this.cropArea.height));
                this.cropArea.width = Math.min(this.cropArea.width, imgLeft + imgWidth - this.cropArea.x);
                this.cropArea.height = Math.min(this.cropArea.height, imgTop + imgHeight - this.cropArea.y);
            }

            // 結束拖動
            handleCropEnd(e) {
                if (this.isDragging) {
                    this.isDragging = false;
                    this.resizeHandle = null;
                    
                    // 自動生成預覽
                    if (this.originalImage) {
                        this.generatePreviews();
                    }
                }
            }

            // 尺寸預設點擊
            handleSizePresetClick(e) {
                const sizeBtn = e.target.closest('.size-btn');
                if (!sizeBtn) return;
                
                const size = sizeBtn.dataset.size;
                if (this.selectedSizes.has(size)) {
                    this.selectedSizes.delete(size);
                    sizeBtn.classList.remove('active');
                } else {
                    this.selectedSizes.add(size);
                    sizeBtn.classList.add('active');
                }
                
                this.updateBatchExport();
            }

            // 自定義尺寸變更
            handleCustomSizeChange() {
                this.customWidth = parseInt(this.customWidthInput.value) || null;
                this.customHeight = parseInt(this.customHeightInput.value) || null;
                this.updateBatchExport();
            }

            // 品質調整
            handleQualityChange() {
                this.quality = parseFloat(this.qualitySlider.value);
                this.qualityValue.textContent = Math.round(this.quality * 100) + '%';
            }

            // 更新批量導出列表
            updateBatchExport() {
                this.batchExport.innerHTML = '';
                
                // 預設尺寸
                this.selectedSizes.forEach(size => {
                    this.createExportItem(`${size}×${size}`, size);
                });
                
                // 自定義尺寸
                if (this.customWidth && this.customHeight) {
                    this.createExportItem(`${this.customWidth}×${this.customHeight}`, 'custom');
                }
            }

            createExportItem(label, id) {
                const item = document.createElement('div');
                item.className = 'export-item';
                item.innerHTML = `
                    <input type="checkbox" class="export-checkbox" checked data-id="${id}">
                    <span class="export-size">${label}</span>
                    <div class="export-preview" id="preview-${id}">預覽</div>
                `;
                this.batchExport.appendChild(item);
            }

            // 生成預覽
            generatePreviews() {
                if (!this.originalImage) return;
                
                this.previewGrid.innerHTML = '';
                this.downloadSingleBtn.disabled = false;
                this.downloadBatchBtn.disabled = false;
                
                // 生成預設尺寸預覽
                this.selectedSizes.forEach(size => {
                    const sizeNum = parseInt(size);
                    this.createPreview(sizeNum, sizeNum, `${size}×${size}`);
                });
                
                // 生成自定義尺寸預覽
                if (this.customWidth && this.customHeight) {
                    this.createPreview(this.customWidth, this.customHeight, `${this.customWidth}×${this.customHeight}`);
                }
            }

            createPreview(width, height, label) {
                // 創建預覽元素
                const previewItem = document.createElement('div');
                previewItem.className = 'preview-item';
                
                const canvas = document.createElement('canvas');
                canvas.className = 'preview-canvas';
                canvas.width = width;
                canvas.height = height;
                
                const info = document.createElement('div');
                info.className = 'preview-info';
                info.textContent = label;
                
                previewItem.appendChild(canvas);
                previewItem.appendChild(info);
                this.previewGrid.appendChild(previewItem);
                
                // 繪製圖片
                this.drawImageToCanvas(canvas, width, height);
                
                // 點擊下載單個
                previewItem.addEventListener('click', () => {
                    this.downloadCanvasImage(canvas, `icon_${width}x${height}.png`);
                });
            }

            drawImageToCanvas(canvas, width, height) {
                const ctx = canvas.getContext('2d');
                const img = this.originalImage;
                
                // 使用高品質縮放
                ctx.imageSmoothingEnabled = true;
                ctx.imageSmoothingQuality = 'high';
                
                let sourceX, sourceY, sourceWidth, sourceHeight;
                
                if (this.cropMode === 'manual') {
                    // 手動裁剪：使用用戶選擇的區域
                    const imgWidth = this.previewImg.clientWidth;
                    const imgHeight = this.previewImg.clientHeight;
                    const imgLeft = (this.imagePreview.clientWidth - imgWidth) / 2;
                    const imgTop = (this.imagePreview.clientHeight - imgHeight) / 2;
                    
                    // 計算相對於圖片的裁剪區域
                    const relativeX = (this.cropArea.x - imgLeft) / imgWidth;
                    const relativeY = (this.cropArea.y - imgTop) / imgHeight;
                    const relativeWidth = this.cropArea.width / imgWidth;
                    const relativeHeight = this.cropArea.height / imgHeight;
                    
                    // 轉換為原圖坐標
                    sourceX = Math.max(0, relativeX * img.width);
                    sourceY = Math.max(0, relativeY * img.height);
                    sourceWidth = Math.min(img.width - sourceX, relativeWidth * img.width);
                    sourceHeight = Math.min(img.height - sourceY, relativeHeight * img.height);
                } else {
                    // 自動裁剪：居中正方形裁剪
                    const sourceSize = Math.min(img.width, img.height);
                    sourceX = (img.width - sourceSize) / 2;
                    sourceY = (img.height - sourceSize) / 2;
                    sourceWidth = sourceSize;
                    sourceHeight = sourceSize;
                }
                
                // 繪製圖片
                ctx.drawImage(
                    img,
                    sourceX, sourceY, sourceWidth, sourceHeight,
                    0, 0, width, height
                );
            }

            // 下載單個圖片
            downloadSingle() {
                // 下載第一個預覽
                const firstCanvas = this.previewGrid.querySelector('.preview-canvas');
                if (firstCanvas) {
                    const size = firstCanvas.width;
                    this.downloadCanvasImage(firstCanvas, `icon_${size}x${size}.png`);
                }
            }

            downloadCanvasImage(canvas, filename) {
                canvas.toBlob((blob) => {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    a.click();
                    URL.revokeObjectURL(url);
                }, 'image/png', this.quality);
            }

            // 批量下載
            async downloadBatch() {
                const zip = new JSZip();
                const promises = [];
                
                // 獲取選中的導出項目
                const checkedItems = this.batchExport.querySelectorAll('.export-checkbox:checked');
                
                checkedItems.forEach(checkbox => {
                    const id = checkbox.dataset.id;
                    let width, height;
                    
                    if (id === 'custom') {
                        width = this.customWidth;
                        height = this.customHeight;
                    } else {
                        width = height = parseInt(id);
                    }
                    
                    // 創建臨時canvas
                    const canvas = document.createElement('canvas');
                    canvas.width = width;
                    canvas.height = height;
                    this.drawImageToCanvas(canvas, width, height);
                    
                    // 添加到ZIP
                    const promise = new Promise((resolve) => {
                        canvas.toBlob((blob) => {
                            zip.file(`icon_${width}x${height}.png`, blob);
                            resolve();
                        }, 'image/png', this.quality);
                    });
                    
                    promises.push(promise);
                });
                
                // 等待所有圖片處理完成
                await Promise.all(promises);
                
                // 生成並下載ZIP
                const zipBlob = await zip.generateAsync({ type: 'blob' });
                const url = URL.createObjectURL(zipBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'icons_batch.zip';
                a.click();
                URL.revokeObjectURL(url);
            }

            // 重置
            reset() {
                this.originalImage = null;
                this.selectedSizes = new Set(['32', '64', '128']);
                this.customWidth = null;
                this.customHeight = null;
                this.cropMode = 'auto';
                this.cropArea = { x: 0, y: 0, width: 100, height: 100 };
                this.isDragging = false;
                this.resizeHandle = null;
                
                // 重置UI
                this.uploadZone.style.display = 'flex';
                this.imagePreview.style.display = 'none';
                this.previewGrid.innerHTML = '';
                this.customWidthInput.value = '';
                this.customHeightInput.value = '';
                this.imageInput.value = '';
                
                // 重置裁剪模式按鈕
                this.autoCropBtn.classList.add('active');
                this.manualCropBtn.classList.remove('active');
                this.cropSelection.style.display = 'none';
                
                // 重置按鈕狀態
                this.generateBtn.disabled = true;
                this.downloadSingleBtn.disabled = true;
                this.downloadBatchBtn.disabled = true;
                
                // 重置尺寸選擇
                this.sizePresets.querySelectorAll('.size-btn').forEach(btn => {
                    const size = btn.dataset.size;
                    if (this.selectedSizes.has(size)) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                });
                
                this.updateBatchExport();
            }
        }

        // 初始化應用
        document.addEventListener('DOMContentLoaded', () => {
            new ImageCutter();
        });
    </script>
</body>
</html>